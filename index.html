<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithmic Garden - AR Gallery</title>
    
    <!-- Model Viewer for AR Support -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #000000;
            --secondary: #ffffff;
            --accent: #0055ff;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-dark: #666666;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: var(--secondary);
            color: var(--primary);
            line-height: 1.6;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--secondary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-medium);
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray-dark);
            font-size: 0.9rem;
        }

        /* Error Message */
        .error-message {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
            padding: 1rem;
            margin: 2rem;
            text-align: center;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Header */
        .header {
            background: var(--secondary);
            border-bottom: 1px solid var(--gray-medium);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .title-group {
            margin-bottom: 1.5rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-bottom: 0.25rem;
        }

        .subtitle {
            color: var(--gray-dark);
            font-size: 0.95rem;
        }

        /* Student Navigation */
        .nav-container {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
            font-weight: 500;
        }

        .student-nav {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .student-btn {
            padding: 0.625rem 1.25rem;
            background: var(--gray-light);
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--primary);
        }

        .student-btn:hover {
            background: var(--secondary);
            border-color: var(--accent);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .student-btn.active {
            background: var(--accent);
            color: var(--secondary);
            border-color: var(--accent);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Work Display */
        .work-display {
            display: grid;
            gap: 2rem;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section */
        .section {
            background: var(--secondary);
            border: 1px solid var(--gray-medium);
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .section-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .section-description {
            color: var(--gray-dark);
            font-size: 0.875rem;
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .image-card {
            position: relative;
            background: var(--gray-light);
            border: 1px solid var(--gray-medium);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--accent);
        }

        .image-card img {
            width: 100%;
            height: 280px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .image-card:hover img {
            transform: scale(1.05);
        }

        .image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .image-card:hover .image-label {
            transform: translateY(0);
        }

        /* Model Viewer Section */
        .model-viewer-container {
            background: var(--gray-light);
            border: 1px solid var(--gray-medium);
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }

        model-viewer {
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #f8f8f8 0%, #e8e8e8 100%);
        }

        model-viewer::part(default-progress-bar) {
            height: 4px;
            background: var(--accent);
        }

        /* Custom AR Button */
        .ar-button-container {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .custom-ar-button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .custom-ar-button:hover:not(:disabled) {
            background: #0044dd;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .custom-ar-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .custom-ar-button svg {
            width: 20px;
            height: 20px;
        }

        /* AR Instructions */
        .ar-instructions {
            background: var(--gray-light);
            border: 1px solid var(--gray-medium);
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .ar-instructions h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: var(--primary);
        }

        .ar-instructions ul {
            list-style: none;
            padding: 0;
        }

        .ar-instructions li {
            padding: 0.5rem 0;
            color: var(--gray-dark);
            font-size: 0.875rem;
            display: flex;
            align-items: flex-start;
        }

        .ar-instructions li:before {
            content: "→";
            margin-right: 0.75rem;
            color: var(--accent);
            font-weight: bold;
        }

        /* AR Status Message */
        .ar-status {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .ar-status.error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .ar-status.success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .ar-status.show {
            display: block;
        }

        /* Controls */
        .model-controls {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid var(--gray-medium);
        }

        .control-btn {
            padding: 0.5rem 1rem;
            background: var(--secondary);
            border: 1px solid var(--gray-medium);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            color: var(--primary);
        }

        .control-btn:hover {
            background: var(--accent);
            color: var(--secondary);
            border-color: var(--accent);
        }

        /* Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .close-lightbox {
            position: absolute;
            top: 2rem;
            right: 2rem;
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .close-lightbox:hover {
            opacity: 1;
        }

        .close-lightbox:before,
        .close-lightbox:after {
            content: '';
            position: absolute;
            width: 30px;
            height: 2px;
            background: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .close-lightbox:after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        /* Info Cards */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: var(--gray-light);
            padding: 1.25rem;
            border: 1px solid var(--gray-medium);
        }

        .info-card h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .info-card p {
            font-size: 0.875rem;
            color: var(--gray-dark);
            line-height: 1.5;
        }

        /* Data Source Indicator */
        .data-source {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--gray-medium);
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            color: var(--gray-dark);
            z-index: 50;
        }

        .data-source code {
            background: var(--gray-light);
            padding: 0.125rem 0.25rem;
            font-family: monospace;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 1.25rem 1.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .container {
                padding: 0 1.5rem;
                margin: 1.5rem auto;
            }

            .image-grid {
                grid-template-columns: 1fr;
            }

            model-viewer {
                height: 400px;
            }

            .section {
                padding: 1.5rem;
            }

            .model-controls {
                flex-wrap: wrap;
            }

            .data-source {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .student-nav {
                width: 100%;
            }

            .student-btn {
                flex: 1;
                min-width: calc(50% - 0.25rem);
            }
        }

        /* No border radius as requested */
        * {
            border-radius: 0 !important;
        }

        /* AR Badge */
        .ar-badge {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
            letter-spacing: 0.05em;
        }

        .small-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading exhibition data...</div>
        </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <header class="header">
        <div class="header-content">
            <div class="title-group">
                <h1 id="exhibitionTitle">Algorithmic Garden <span class="ar-badge">AR ENABLED</span></h1>
                <p class="subtitle" id="exhibitionSubtitle">Loading...</p>
            </div>
            
            <nav class="nav-container">
                <span class="nav-label">Select Artist:</span>
                <div class="student-nav" id="studentNav">
                    <!-- Student buttons will be populated here -->
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="workDisplay" class="work-display">
            <!-- Dynamic content will be loaded here -->
        </div>
    </main>

    <!-- Lightbox for full-size images -->
    <div class="lightbox" id="lightbox">
        <div class="close-lightbox"></div>
        <img src="" alt="Full view">
    </div>

    <!-- Data Source Indicator -->
    <div class="data-source">
        Data source: <code id="dataSourceFile">exhibition-data.json</code>
    </div>

    <script type="module">
        // Configuration
        const CONFIG = {
            dataFile: 'exhibition-data.json', // Path to your JSON file
            usePlaceholders: false, // Set to true to use placeholder images for testing
            debugMode: false, // Set to true for debug information
            //cacheTimeout: 300000 // 5 minutes cache timeout
            cacheTimeout: 100000 // 1.5 minutes cache timeout
        };

        // Global variables
        let exhibitionData = null;
        let currentArtist = null;
        let modelViewer = null;

        // Detect iOS Safari
        function isIOSSafari() {
            const ua = window.navigator.userAgent;
            const iOS = !!ua.match(/iPad/i) || !!ua.match(/iPhone/i);
            const webkit = !!ua.match(/WebKit/i);
            const iOSSafari = iOS && webkit && !ua.match(/CriOS/i) && !ua.match(/FxiOS/i);
            return iOSSafari;
        }

        // Detect AR support
        function detectARSupport() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const hasWebXR = 'xr' in navigator;
            
            return {
                isIOS: isIOS,
                isAndroid: isAndroid,
                hasWebXR: hasWebXR,
                isSafari: isIOSSafari(),
                supportsAR: isIOS || (isAndroid && hasWebXR)
            };
        }

        // Load exhibition data from JSON
        async function loadExhibitionData() {
            try {
                // Update data source indicator
                document.getElementById('dataSourceFile').textContent = CONFIG.dataFile;
                
                // Check for cached data
                const cachedData = sessionStorage.getItem('exhibitionData');
                const cacheTime = sessionStorage.getItem('exhibitionDataTime');
                
                if (cachedData && cacheTime && (Date.now() - parseInt(cacheTime)) < CONFIG.cacheTimeout) {
                    console.log('Using cached exhibition data');
                    return JSON.parse(cachedData);
                }
                
                // Fetch fresh data
                console.log('Fetching exhibition data from:', CONFIG.dataFile);
                const response = await fetch(CONFIG.dataFile);
                
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Process data with placeholders if enabled
                if (CONFIG.usePlaceholders && data.placeholderAssets?.enabled) {
                    data.artists = processPlaceholderData(data.artists, data.placeholderAssets);
                }
                
                // Cache the data
                sessionStorage.setItem('exhibitionData', JSON.stringify(data));
                sessionStorage.setItem('exhibitionDataTime', Date.now().toString());
                
                return data;
            } catch (error) {
                console.error('Error loading exhibition data:', error);
                throw error;
            }
        }

        // Process placeholder data for testing
        function processPlaceholderData(artists, placeholderAssets) {
            const colors = ['ff6b6b', '4ecdc4', '45b7d1', '96ceb4', 'ffeaa7', 'dfe6e9', 'fd79a8', 'fdcb6e', '6c5ce7'];
            
            return artists.map((artist, artistIndex) => {
                // Replace composition URLs with placeholders
                artist.compositions = artist.compositions.map((comp, i) => ({
                    ...comp,
                    url: `${placeholderAssets.compositionPlaceholder}${colors[i % colors.length]}/ffffff?text=${encodeURIComponent(comp.title)}`
                }));
                
                // Replace render URLs with placeholders
                artist.renders = artist.renders.map((render, i) => ({
                    ...render,
                    url: `${placeholderAssets.renderPlaceholder}${colors[(i + 3) % colors.length]}/ffffff?text=${encodeURIComponent(render.title)}`
                }));
                
                // Replace model URLs with test models
                if (placeholderAssets.testModels) {
                    artist.model.url = placeholderAssets.testModels.glb[artistIndex % placeholderAssets.testModels.glb.length];
                    artist.model.iosUrl = placeholderAssets.testModels.usdz[artistIndex % placeholderAssets.testModels.usdz.length];
                    artist.model.poster = placeholderAssets.posterPlaceholder;
                }
                
                return artist;
            });
        }

        // Initialize the gallery
        async function init() {
            try {
                // Load data
                exhibitionData = await loadExhibitionData();
                
                // Update page title and header
                if (exhibitionData.exhibition) {
                    document.title = exhibitionData.exhibition.title || 'Algorithmic Garden';
                    document.getElementById('exhibitionTitle').innerHTML = 
                        `${exhibitionData.exhibition.title} <span class="ar-badge">AR ENABLED</span>`;
                    document.getElementById('exhibitionSubtitle').textContent = 
                        exhibitionData.exhibition.subtitle || '';
                }
                
                // Populate artist navigation
                populateArtistNav();
                
                // Load first artist by default
                if (exhibitionData.artists && exhibitionData.artists.length > 0) {
                    loadArtistWork(0);
                }
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').classList.add('hidden');
                }, 500);
                
            } catch (error) {
                showError(`Failed to load exhibition data. Please check that ${CONFIG.dataFile} exists and is valid JSON.`);
                document.getElementById('loadingScreen').classList.add('hidden');
            }
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // Populate artist navigation
        function populateArtistNav() {
            const nav = document.getElementById('studentNav');
            nav.innerHTML = '';
            
            if (!exhibitionData.artists || exhibitionData.artists.length === 0) {
                nav.innerHTML = '<span style="color: var(--gray-dark);">No artists found</span>';
                return;
            }
            
            exhibitionData.artists.forEach((artist, index) => {
                const btn = document.createElement('button');
                btn.className = 'student-btn';
                btn.textContent = artist.name;
                btn.onclick = () => {
                    document.querySelectorAll('.student-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadArtistWork(index);
                };
                if (index === 0) btn.classList.add('active');
                nav.appendChild(btn);
            });
        }

        // Load artist work
        function loadArtistWork(artistIndex) {
            const artist = exhibitionData.artists[artistIndex];
            if (!artist) return;
            
            currentArtist = artist;
            const display = document.getElementById('workDisplay');
            const arSupport = detectARSupport();
            
            display.style.opacity = '0';
            
            setTimeout(() => {
                // Determine which model URL to use
                const modelUrl = arSupport.isIOS && artist.model.iosUrl ? artist.model.iosUrl : artist.model.url;
                
                display.innerHTML = `
                    <!-- Artist Info -->
                    <div class="section">
                        <div class="info-grid">
                            <div class="info-card">
                                <h4>Artist</h4>
                                <p>${artist.name}</p>
                            </div>
                            <div class="info-card">
                                <h4>Project Focus</h4>
                                <p>${artist.bio}</p>
                            </div>
                            <div class="info-card">
                                <h4>Process</h4>
                                <p>2D Scanning → Digital Compositing → 3D Modeling → AR Experience</p>
                            </div>
                        </div>
                    </div>

                    <!-- Scanned Compositions -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Scanned Compositions</h2>
                            <p class="section-description">Original 2D scans composited and degraded through iterative digital processes</p>
                        </div>
                        <div class="image-grid">
                            ${artist.compositions.map((item, i) => `
                                <div class="image-card" onclick="openLightbox('${item.url}')">
                                    <img src="${item.url}" alt="${item.title}" loading="lazy" 
                                         onerror="this.src='https://via.placeholder.com/600x400/cccccc/666666?text=Image+Not+Found'">
                                    <div class="image-label">${item.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- 3D Renders -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">3D Renders</h2>
                            <p class="section-description">Blender renders showcasing the textured 3D models in virtual environments</p>
                        </div>
                        <div class="image-grid">
                            ${artist.renders.map((item, i) => `
                                <div class="image-card" onclick="openLightbox('${item.url}')">
                                    <img src="${item.url}" alt="${item.title}" loading="lazy"
                                         onerror="this.src='https://via.placeholder.com/600x400/cccccc/666666?text=Image+Not+Found'">
                                    <div class="image-label">${item.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Interactive 3D Model with AR -->
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Interactive 3D Model</h2>
                            <p class="section-description">Explore the model in 3D or place it in your space using AR</p>
                        </div>
                        
                        <div class="model-viewer-container">
                            <model-viewer
                                id="modelViewer"
                                src="${artist.model.url}"
                                ${artist.model.iosUrl ? `ios-src="${artist.model.iosUrl}"` : ''}
                                poster="${artist.model.poster}"
                                alt="${artist.model.alt}"
                                auto-rotate
                                camera-controls
                                shadow-intensity="1"
                                ar
                                ar-modes="webxr scene-viewer quick-look"
                                ar-scale="auto"
                                xr-environment
                                quick-look-browsers="safari chrome">
                            </model-viewer>
                            
                            <div class="ar-button-container">
                                <button id="customARButton" class="custom-ar-button" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" stroke="currentColor"/>
                                        <polyline points="11 7 11 13 17 13"/>
                                    </svg>
                                    <span id="arButtonText">View in AR</span>
                                </button>
                            </div>
                            
                            <div class="model-controls">
                                <button class="control-btn" onclick="resetModelView()">Reset View</button>
                                <button class="control-btn" onclick="toggleAutoRotate()">Toggle Rotation</button>
                                <button class="control-btn" onclick="changeEnvironment()">Change Light</button>
                            </div>
                        </div>

                        <div id="arStatus" class="ar-status"></div>

                        <div class="ar-instructions">
                            <h3>AR Viewing Instructions</h3>
                            <ul>
                                <li><strong>iOS Safari:</strong> ${arSupport.isSafari ? 'Tap "View in AR" to open in AR Quick Look' : 'Please open this page in Safari to use AR'}</li>
                                <li><strong>Android Chrome:</strong> ${arSupport.isAndroid ? 'Tap "View in AR" to open in Scene Viewer' : 'AR available on Android devices'}</li>
                                <li><strong>Desktop:</strong> Use mouse to rotate, scroll to zoom the 3D model</li>
                                <li><strong>AR Placement:</strong> Once in AR mode, scan the floor and tap to place the model</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                display.style.opacity = '1';
                
                // Setup AR after model viewer is loaded
                setTimeout(() => {
                    setupARButton(artist.model);
                }, 100);
            }, 300);
        }

        // Setup custom AR button
        function setupARButton(modelData) {
            const viewer = document.getElementById('modelViewer');
            const customButton = document.getElementById('customARButton');
            const arStatus = document.getElementById('arStatus');
            const arSupport = detectARSupport();
            
            if (!viewer || !customButton) return;
            
            // Show button if AR is supported
            if (arSupport.supportsAR) {
                customButton.style.display = 'flex';
                
                customButton.onclick = async () => {
                    const buttonText = document.getElementById('arButtonText');
                    const originalText = buttonText.textContent;
                    
                    try {
                        customButton.disabled = true;
                        buttonText.innerHTML = '<span class="small-loading-spinner"></span> Launching AR...';
                        
                        if (arSupport.isIOS) {
                            // For iOS, use USDZ format
                            if (modelData.iosUrl) {
                                const a = document.createElement('a');
                                a.href = modelData.iosUrl;
                                a.rel = 'ar';
                                
                                const img = document.createElement('img');
                                img.style.display = 'none';
                                document.body.appendChild(img);
                                
                                a.appendChild(img);
                                document.body.appendChild(a);
                                a.click();
                                
                                setTimeout(() => {
                                    document.body.removeChild(a);
                                }, 100);
                                
                                showStatus('AR Quick Look launched! Look for the AR viewer.', 'success');
                            } else {
                                if (viewer.canActivateAR) {
                                    await viewer.activateAR();
                                    showStatus('AR mode activated!', 'success');
                                } else {
                                    showStatus('Please provide a USDZ file for iOS AR support', 'error');
                                }
                            }
                        } else if (arSupport.isAndroid) {
                            if (viewer.canActivateAR) {
                                await viewer.activateAR();
                                showStatus('AR mode activated!', 'success');
                            } else {
                                showStatus('AR not available. Please ensure you have Google Play Services for AR installed.', 'error');
                            }
                        }
                    } catch (error) {
                        console.error('AR activation error:', error);
                        showStatus(`Failed to launch AR: ${error.message}`, 'error');
                    } finally {
                        customButton.disabled = false;
                        buttonText.textContent = originalText;
                    }
                };
            } else {
                if (!arSupport.isSafari && arSupport.isIOS) {
                    showStatus('Please open this page in Safari to use AR features', 'error');
                } else if (!arSupport.isIOS && !arSupport.isAndroid) {
                    showStatus('AR features are available on iOS and Android mobile devices', 'error');
                }
            }
            
            function showStatus(message, type = '') {
                arStatus.textContent = message;
                arStatus.className = 'ar-status show ' + type;
                
                if (type === 'success') {
                    setTimeout(() => arStatus.classList.remove('show'), 3000);
                }
            }
        }

        // Model viewer controls
        window.resetModelView = function() {
            const viewer = document.getElementById('modelViewer');
            if (viewer) {
                viewer.cameraOrbit = '0deg 75deg 105%';
                viewer.fieldOfView = '30deg';
            }
        };

        window.toggleAutoRotate = function() {
            const viewer = document.getElementById('modelViewer');
            if (viewer) {
                viewer.autoRotate = !viewer.autoRotate;
            }
        };

        let environmentIndex = 0;
        const environments = ['', 'neutral', 'legacy'];
        window.changeEnvironment = function() {
            const viewer = document.getElementById('modelViewer');
            if (viewer) {
                environmentIndex = (environmentIndex + 1) % environments.length;
                if (environments[environmentIndex]) {
                    viewer.setAttribute('environment-image', environments[environmentIndex]);
                } else {
                    viewer.removeAttribute('environment-image');
                }
            }
        };

        // Lightbox functionality
        window.openLightbox = function(src) {
            const lightbox = document.getElementById('lightbox');
            const img = lightbox.querySelector('img');
            img.src = src;
            lightbox.classList.add('active');
        };

        // Close lightbox
        document.getElementById('lightbox').addEventListener('click', function() {
            this.classList.remove('active');
        });

        // Prevent image dragging
        document.addEventListener('dragstart', function(e) {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);

        // Log configuration for debugging
        if (CONFIG.debugMode) {
            console.log('Gallery Configuration:', CONFIG);
            console.log('AR Support:', detectARSupport());
        }
    </script>
</body>
</html>
